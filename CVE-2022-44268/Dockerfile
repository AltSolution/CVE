# Use a base image with PHP and Apache
FROM php:7.4-apache

# Install required system packages
RUN apt-get update && apt-get install -y \
    libmagickwand-dev \
    && rm -rf /var/lib/apt/lists/*

# Set the desired version of ImageMagick
ENV IMAGEMAGICK_VERSION 7.1.0-33

# Download and install the desired version of ImageMagick
RUN curl -L -o /tmp/imagemagick.tar.xz https://imagemagick.org/download/releases/ImageMagick-${IMAGEMAGICK_VERSION}.tar.xz && \
    tar -xf /tmp/imagemagick.tar.xz -C /tmp && \
    cd /tmp/ImageMagick-* && \
    ./configure --with-php --with-imagick && \
    make && \
    make install && \
    ldconfig /usr/local/lib && \
    rm -rf /tmp/imagemagick.tar.xz /tmp/ImageMagick-*

# Enable the PHP extension for ImageMagick
RUN pecl install imagick && \
    docker-php-ext-enable imagick

# Configure Apache
COPY files/000-default.conf /etc/apache2/sites-available/000-default.conf

# Copy your PHP application files to the working directory
COPY files/index.php /var/www/html/public/index.php
COPY files/pi.php /var/www/html/public/pi.php

# Create upload directory and set permissions
RUN mkdir -p /var/www/html/public/upload && \
    chmod 700 /var/www/html/public/upload && \
    chown www-data:www-data /var/www/html/public/upload

# Start Apache
CMD ["apache2-foreground"]
